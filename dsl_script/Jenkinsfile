pipeline {
    agent { label 'slave' }

    parameters {
        choice(name: 'TARGET_OS', choices: ['windows', 'linux'], description: 'Select target OS (windows or linux)')
        string(name: 'PLAYBOOK', defaultValue: '', description: 'Name of the playbook to run')
        password(name: 'AUTH_PASS', defaultValue: '', description: 'Password for the target host (WinRM for Windows / SSH for Linux)')
    }

    environment {
        INVENTORY_FILE = 'ansible/inventories/hosts.yml'
        PLAYBOOKS_DIR  = 'ansible/playbooks'
    }

    stages {
        stage('Checkout Repository') {
            steps {
                echo "ðŸ“¥ Checking out repository..."
                checkout scm
            }
        }

        stage('Select Target Host') {
            steps {
                script {
                    def inv = readYaml file: "${env.INVENTORY_FILE}"
                    def hosts = []

                    if (params.TARGET_OS == 'windows') {
                        if (inv.all.children.windows?.hosts) {
                            hosts = inv.all.children.windows.hosts.keySet().toList()
                        }
                    } else { // linux
                        if (inv.all.children.linux?.hosts) {
                            hosts = inv.all.children.linux.hosts.keySet().toList()
                        }
                    }

                    if (hosts.isEmpty()) {
                        error "No hosts found for group ${params.TARGET_OS} in inventory."
                    }

                    def userSelection = input(
                        message: "Select target host for ${params.TARGET_OS}:",
                        parameters: [
                            [
                                $class: 'ChoiceParameterDefinition',
                                choices: hosts.join("\n"),
                                description: 'Choose the target host from the inventory',
                                name: 'TARGET_HOST'
                            ]
                        ]
                    )

                    env.TARGET_HOST = userSelection.TARGET_HOST
                    echo "Selected host: ${env.TARGET_HOST}"
                }
            }
        }

        stage('Trigger Downstream Deployment') {
            steps {
                script {
                    if (params.TARGET_OS == 'windows') {
                        build job: "CD-Windows",
                              parameters: [
                                  string(name: 'TARGET_HOST', value: env.TARGET_HOST),
                                  string(name: 'PLAYBOOK', value: params.PLAYBOOK),
                                  password(name: 'WINRM_PASS', value: params.AUTH_PASS)
                              ]
                    } else {
                        build job: "CD-Linux",
                              parameters: [
                                  string(name: 'TARGET_HOST', value: env.TARGET_HOST),
                                  string(name: 'PLAYBOOK', value: params.PLAYBOOK),
                                  password(name: 'SSH_PASS', value: params.AUTH_PASS)
                              ]
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Upstream Pipeline finished."
        }
    }
}
